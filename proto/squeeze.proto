syntax = "proto3";

package squeeze;

option csharp_namespace = "AlphaSqueeze.Shared.Grpc";

// gRPC service for squeeze signal analysis
service SqueezeEngine {
  // Get squeeze signal for a specific ticker
  rpc GetSqueezeSignal (SqueezeRequest) returns (SqueezeResponse);

  // Batch analysis for multiple tickers
  rpc GetBatchSignals (BatchSqueezeRequest) returns (BatchSqueezeResponse);

  // Get top squeeze candidates
  rpc GetTopCandidates (TopCandidatesRequest) returns (TopCandidatesResponse);
}

// Request for single ticker analysis
message SqueezeRequest {
  string ticker = 1;              // 股票代號
  double borrow_change = 2;       // 借券變化量
  double margin_ratio = 3;        // 券資比
  double current_iv = 4;          // 當前權證 IV
  double hv_20d = 5;              // 標的歷史波動率
  double cb_premium = 6;          // CB 溢價 (預留)
  double close_price = 7;         // 收盤價
  int64 volume = 8;               // 成交量
}

// Response with squeeze analysis
message SqueezeResponse {
  string ticker = 1;              // 股票代號
  int32 score = 2;                // 0-100 評分
  string trend = 3;               // 趨勢預判 (BULLISH/NEUTRAL/BEARISH)
  string comment = 4;             // 戰術建議
  FactorScores factors = 5;       // 各維度分數
}

// Individual factor scores
message FactorScores {
  double borrow_score = 1;        // 法人空頭分數 (F_B)
  double gamma_score = 2;         // Gamma效應分數 (F_G)
  double margin_score = 3;        // 散戶燃料分數 (F_M)
  double momentum_score = 4;      // 價量動能分數 (F_V)
}

// Batch request for multiple tickers
message BatchSqueezeRequest {
  repeated SqueezeRequest requests = 1;
}

// Batch response
message BatchSqueezeResponse {
  repeated SqueezeResponse responses = 1;
}

// Request for top squeeze candidates
message TopCandidatesRequest {
  int32 limit = 1;                // 返回數量上限 (default: 10)
  string date = 2;                // 交易日期 (YYYY-MM-DD)
  int32 min_score = 3;            // 最低分數門檻 (default: 60)
}

// Response with top candidates
message TopCandidatesResponse {
  repeated SqueezeResponse candidates = 1;
  string analysis_date = 2;       // 分析日期
  string generated_at = 3;        // 產生時間
}

// =============================================
// CB Warning Light Service (CB 預警燈服務)
// =============================================

// CB Warning Light Service
service CBWarningEngine {
  // 取得單一 CB 預警狀態
  rpc GetCBWarning (CBWarningRequest) returns (CBWarningResponse);

  // 取得所有 CB 預警清單
  rpc GetAllCBWarnings (AllCBWarningsRequest) returns (AllCBWarningsResponse);

  // 取得高風險 CB 清單
  rpc GetCriticalCBs (CriticalCBsRequest) returns (CriticalCBsResponse);

  // 更新 CB 追蹤資料 (盤後批次處理)
  rpc UpdateCBTracking (UpdateCBTrackingRequest) returns (UpdateCBTrackingResponse);
}

// 單一 CB 預警請求
message CBWarningRequest {
  string cb_ticker = 1;           // CB 代號
  string trade_date = 2;          // 交易日期 (YYYY-MM-DD)
}

// CB 預警回應
message CBWarningResponse {
  string cb_ticker = 1;           // CB 代號
  string underlying_ticker = 2;   // 標的股票代號
  string trade_date = 3;          // 交易日期
  double current_price = 4;       // 標的收盤價
  double conversion_price = 5;    // 轉換價
  double price_ratio = 6;         // 股價/轉換價 * 100
  bool is_above_trigger = 7;      // 是否超過觸發門檻
  int32 consecutive_days = 8;     // 連續超過天數
  int32 days_remaining = 9;       // 距離觸發剩餘天數
  double trigger_progress = 10;   // 觸發進度 (0-100%)
  double outstanding_balance = 11;// 剩餘餘額 (億)
  double balance_change_pct = 12; // 餘額變化率 (%)
  string warning_level = 13;      // SAFE/CAUTION/WARNING/CRITICAL
  string comment = 14;            // 風險提示
}

// 所有 CB 預警請求
message AllCBWarningsRequest {
  string trade_date = 1;          // 交易日期 (YYYY-MM-DD)
  string min_warning_level = 2;   // 最低預警等級篩選 (SAFE/CAUTION/WARNING/CRITICAL)
}

// 所有 CB 預警回應
message AllCBWarningsResponse {
  repeated CBWarningResponse warnings = 1;
  string analysis_date = 2;       // 分析日期
  int32 total_count = 3;          // 總 CB 數量
  int32 critical_count = 4;       // CRITICAL 等級數量
  int32 warning_count = 5;        // WARNING 等級數量
  int32 caution_count = 6;        // CAUTION 等級數量
}

// 高風險 CB 請求
message CriticalCBsRequest {
  string trade_date = 1;          // 交易日期 (YYYY-MM-DD)
  int32 limit = 2;                // 返回數量上限 (default: 10)
  int32 min_days_above = 3;       // 最低連續天數 (default: 15)
}

// 高風險 CB 回應
message CriticalCBsResponse {
  repeated CBWarningResponse critical_cbs = 1;
  string analysis_date = 2;       // 分析日期
}

// 更新 CB 追蹤請求 (批次)
message UpdateCBTrackingRequest {
  string trade_date = 1;          // 交易日期
  repeated CBTrackingData tracking_data = 2;
}

// CB 追蹤資料 (用於批次更新)
message CBTrackingData {
  string cb_ticker = 1;           // CB 代號
  double underlying_close_price = 2;  // 標的收盤價
  double conversion_price = 3;    // 轉換價
  double outstanding_balance = 4; // 剩餘餘額 (億)
}

// 更新 CB 追蹤回應
message UpdateCBTrackingResponse {
  bool success = 1;
  int32 updated_count = 2;        // 更新筆數
  string message = 3;             // 訊息
  repeated CBWarningResponse results = 4;  // 計算結果
}
